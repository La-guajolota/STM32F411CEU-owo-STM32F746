/*
 * WS2812B.c
 *
 *  Created on: May 26, 2024
 *      Author: adria
 */

/*
 * Includes
 */
#include "WS2812B.h"

/*
 * Varibles
 */
extern TIM_HandleTypeDef htim1;
extern DMA_HandleTypeDef hdma_tim1_ch1;

/*
 * DEFINES
 */
#define pwm &htim1
#define dma &hdma_tim1_ch1

void Set_LED(TIRA_t* regleta,uint8_t led_num,uint8_t R,uint8_t G,uint8_t B)
{
	regleta->LEDS[led_num].RGB[0] = R;
	regleta->LEDS[led_num].RGB[1] = G;
	regleta->LEDS[led_num].RGB[2] = B;
}

void WS2812_Send (TIRA_t* regleta)
{
	uint32_t indx = 0;
	uint32_t color;

	for (int i= 0; i<MAX_LED; i++)
	{
	#if USE_BRIGHTNESS
			color = ((LED_Mod[i][1]<<16) | (LED_Mod[i][2]<<8) | (LED_Mod[i][3]));
	#else
			color = ((LED_Data[i][1]<<16) | (LED_Data[i][2]<<8) | (LED_Data[i][3]));
	#endif

		for (int i=23; i>=0; i--)
		{
			if (color&(1<<i))
			{
				pwmData[indx] = 60;  // 2/3 of 90
			}

			else pwmData[indx] = 30;  // 1/3 of 90
			indx++;
		}
	}

	for (int i=0; i<50; i++)
	{
		pwmData[indx] = 0;
		indx++;
	}

	HAL_TIM_PWM_Start_DMA(&htim1, TIM_CHANNEL_1, (uint32_t *)pwmData, indx);
	while (!datasentflag){};
	datasentflag = 0;
}
